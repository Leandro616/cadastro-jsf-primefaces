<!DOCTYPE html>
<ui:composition
  lang="pt-br"
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:h="http://xmlns.jcp.org/jsf/html"
  xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:p="http://primefaces.org/ui"
  xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  template="WEB-INF/template/Layout.xhtml"
>
  <ui:define name="titulo"> Empresas </ui:define>

  <ui:define name="conteudo">
    <f:metadata>
      <f:viewAction action="#{gestaoEmpresasBean.todasEmpresas}" />
    </f:metadata>

    <h:form id="formToolbar">
      <p:messages closable="true">
        <p:autoUpdate />
      </p:messages>

      <p:toolbar>
        <p:toolbarGroup>
          <p:commandButton
            value="Nova Empresa"
            icon="pi pi-plus-circle"
            process="@this"
            actionListener="#{gestaoEmpresasBean.prepararNovaEmpresa}"
            oncomplete="PF('DialogWidgetVar').show()"
            update="formTable"
          />
          <p:commandButton
            type="button"
            value="Exportar Excel"
            icon="pi pi-file-excel"
            styleClass="ui-button-success ml-2"
          />

          <i class="pi pi-pause mx-3"></i>
          <p:commandButton
            type="button"
            title="Editar"
            icon="pi pi-pencil"
            styleClass="ui-button-warning mr-2"
          />
          <p:commandButton
            type="button"
            title="Excluir"
            icon="pi pi-trash"
            styleClass="ui-button-danger"
          />
        </p:toolbarGroup>
        <p:toolbarGroup align="right">
          <p:inputText
            onkeydown="pesquisar(event)"
            id="termoPesquisa"
            value="#{gestaoEmpresasBean.termoPesquisa}"
            placeholder="Digite um termo para pesquisa..."
            styleClass="mr-2"
            size="30"
          />

          <!-- como o primefaces usa ajax ele não atualiza todos os componentes em uma requisisão -->
          <!-- por isso usamos aqui o update passando o id do componente ou um alias -->
          <p:commandButton
            widgetVar="btnPesquisarWidgetVar"
            value="Pesquisar"
            icon="pi pi-search"
            process="@this termoPesquisa"
            actionListener="#{gestaoEmpresasBean.pesquisar}"
            update=":formTable:empresasDataTable"
          />
        </p:toolbarGroup>
      </p:toolbar>
    </h:form>

    <h:form id="formTable">
      <p:dataTable
        id="empresasDataTable"
        var="empresa"
        value="#{gestaoEmpresasBean.empresas}"
        paginator="true"
        rows="5"
        paginatorPosition="bottom"
        allowUnsorting="true"
      >
        <p:column headerText="Nome" sortBy="#{empresa.nomeFantasia}">
          <h:outputText value="#{empresa.nomeFantasia}" />
        </p:column>
        <p:column headerText="Razão Social">
          <h:outputText value="#{empresa.razaoSocial}" />
        </p:column>
        <p:column headerText="CNPJ">
          <h:outputText value="#{empresa.cnpj}" />
        </p:column>
        <p:column headerText="Data Fundação">
          <h:outputText value="#{empresa.dataFundacao}" />
        </p:column>
        <p:column headerText="Ramo">
          <h:outputText value="#{empresa.ramoAtividade.descricao}" />
        </p:column>
        <p:column headerText="Tipo">
          <h:outputText value="#{empresa.tipo.descricao}" />
        </p:column>
        <p:column headerText="Faturamento">
          <h:outputText value="#{empresa.faturamento}" />
        </p:column>
      </p:dataTable>

      <!-- propriedade 'rendered' define uma condição para o componente ser renderizado -->
      <!-- nesse caso o dialog só será renderizado quando a empresa for instanciada -->
      <!-- evitando um null pointer -->
      <p:dialog
        id="empresaDialog"
        rendered="#{gestaoEmpresasBean.empresa ne null}"
        header="Nova empresa"
        widgetVar="DialogWidgetVar"
        modal="true"
        resizable="false"
        closeOnEscape="true"
        width="720"
      >
        <div class="formgrid grid ui-fluid">
          <div class="field col-12 md:col-6">
            <p:outputLabel for="razaoSocial" value="Razão Social" />
            <p:inputText
              id="razaoSocial"
              value="#{gestaoEmpresasBean.empresa.razaoSocial}"
              required="true"
              label="Razão Social"
            />
          </div>

          <div class="field col-12 md:col-6">
            <p:outputLabel for="nomeFantasia" value="Nome Fantasia" />
            <p:inputText
              id="nomeFantasia"
              value="#{gestaoEmpresasBean.empresa.nomeFantasia}"
            />
          </div>

          <div class="field col-12 md:col-6">
            <p:outputLabel for="tipo" value="Tipo de Empresa" />
            <p:selectOneMenu
              id="tipo"
              value="#{gestaoEmpresasBean.empresa.tipo}"
              required="true"
            >
              <f:selectItem itemLabel="Selecione..." />
              <f:selectItems
                value="#{gestaoEmpresasBean.tiposEmpresa}"
                var="tipoEmpresa"
                itemLabel="#{tipoEmpresa.descricao}"
                itemValue="#{tipoEmpresa}"
              />
            </p:selectOneMenu>
          </div>

          <div class="field col-12 md:col-6">
            <p:outputLabel for="dataFundacao" value="Data Fundação" />

            <p:datePicker
              locale="br"
              id="dataFundacao"
              value="#{gestaoEmpresasBean.empresa.dataFundacao}"
              label="Data Fundação"
            >
              <f:converter converterId="localDateConverter" />
            </p:datePicker>
          </div>

          <div class="field col-12 md:col-6">
            <p:outputLabel for="cnpj" value="CNPJ" />
            <p:inputMask
              id="cnpj"
              size="18"
              maxlength="18"
              mask="99.999.999/9999-99"
              value="#{gestaoEmpresasBean.empresa.cnpj}"
              label="CNPJ"
              styleClass="w-full"
            >
              <f:validateLength maximum="18" minimum="18" />
            </p:inputMask>
          </div>

          <div class="field col-12 md:col-6">
            <p:outputLabel for="ramoAtividade" value="Ramo" />
            <p:autoComplete
              var="ramo"
              id="ramoAtividade"
              value="#{gestaoEmpresasBean.empresa.ramoAtividade}"
              completeMethod="#{gestaoEmpresasBean.completarRamoAtividade}"
              converter="#{gestaoEmpresasBean.ramoAtividadeConverter}"
              itemLabel="#{ramo.descricao}"
              itemValue="#{ramo}"
            />
          </div>

          <div class="field col-12 md:col-6">
            <p:outputLabel for="faturamento" value="Faturamento" />
            <p:inputText
              id="faturamento"
              value="#{gestaoEmpresasBean.empresa.faturamento}"
              label="Faturamento"
            >
              <f:convertNumber minFractionDigits="2" maxFractionDigits="2" />
              <f:validateDoubleRange minimum="0" />
            </p:inputText>
          </div>
          <div class="col-12 text-center">
            <!-- como o primefaces usa ajax ele não atualiza todos os componentes em uma requisisão -->
            <!-- por isso usamos aqui o update passando o id do componente ou um alias nesse caso -->
            <p:commandButton
              value="Salvar"
              update=":formTable:empresasDataTable"
              actionListener="#{gestaoEmpresasBean.salvar}"
              oncomplete="PF('DialogWidgetVar').hide()"
              styleClass="w-auto"
            />
          </div>
        </div>
      </p:dialog>
    </h:form>

    <h:outputScript library="assets" name="primefaces-locales.js" />
    <script>
      // função para pesquisar ao apertar o enter no input da pesquisa
      // aqui ele somente clica no botão pesquisar que já está chamando os metodos necessários
      function pesquisar(event) {
        if (event.keyCode == 13) {
          event.preventDefault();

          PF("btnPesquisarWidgetVar").jq.click();
        }

        return false;
      }
    </script>
  </ui:define>
</ui:composition>
